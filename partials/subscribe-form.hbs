{{!--
  # Subscribe form with a name and a button #

  ## This partial is called on the following theme files:
  1. partials/subscribe-box.hbs
  1. partials/home/subscribe-form.hbs
--}}

<form data-members-form='signup' class='c-subscribe-form is-membership {{ formClass }}' id='custom-newsletter-form'>
  <div class='c-form-group'>
    <label for='{{ emailLabel }}' class='u-hidden-visually'>{{t 'Your email address' }}</label>
    <input type='email' name='email' class='c-form-group__input' id='{{ emailLabel }}' placeholder='{{t 'Your email address' }}' required data-members-email>
    <button type='submit' value='{{t 'Subscribe' }}' class='c-btn c-form-group__btn'>{{t 'Subscribe' }}</button>
  </div>

  <div class='c-newsletter-options'>
    <p class='u-mb-8'>{{t 'Choose your newsletters:' }}</p>
    <div class='c-checkbox-group'>
      <label class='c-checkbox-label'>
        <input type='checkbox' name='newsletters' value='draft-mode' class='c-checkbox' checked>
        <span class='c-checkbox-text'>Draft Mode</span>
      </label>
      <label class='c-checkbox-label'>
        <input type='checkbox' name='newsletters' value='beating' class='c-checkbox' checked>
        <span class='c-checkbox-text'>beating</span>
      </label>
    </div>
  </div>

  <p class='u-mb-16 unsub'>{{t 'No spam. Unsubscribe any time.' }}</p>

  <div class='c-alert c-alert--success' style='display: none;'>{{t 'Please check your inbox and click the link to confirm your subscription.' }}</div>
  <div class='c-alert c-alert--invalid' style='display: none;'>{{t 'Please enter a valid email address!' }}</div>
  <div class='c-alert c-alert--error' style='display: none;'>{{t 'An error occurred, please try again later.' }}</div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('custom-newsletter-form');
  
  // Debug: log that script is loading
  console.log('Custom newsletter script loaded');
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    console.log('Form submitted, processing...');
    
    const emailInput = form.querySelector('input[type="email"]');
    const submitBtn = form.querySelector('button[type="submit"]');
    const successAlert = form.querySelector('.c-alert--success');
    const invalidAlert = form.querySelector('.c-alert--invalid');
    const errorAlert = form.querySelector('.c-alert--error');
    
    // Hide all alerts
    successAlert.style.display = 'none';
    invalidAlert.style.display = 'none';
    errorAlert.style.display = 'none';
    
    const email = emailInput.value.trim();
    console.log('Email:', email);
    
    // Basic email validation
    if (!email || !isValidEmail(email)) {
      console.log('Invalid email');
      invalidAlert.style.display = 'block';
      return;
    }
    
    // Get selected newsletters
    const selectedNewsletters = Array.from(form.querySelectorAll('input[name="newsletters"]:checked'))
      .map(checkbox => checkbox.value);
    
    console.log('Selected newsletters:', selectedNewsletters);
    
    if (selectedNewsletters.length === 0) {
      errorAlert.textContent = 'Please select at least one newsletter.';
      errorAlert.style.display = 'block';
      return;
    }
    
    // Disable submit button during processing
    submitBtn.disabled = true;
    submitBtn.textContent = 'Subscribing...';
    
    try {
      // Create the member using Ghost's standard API format
      console.log('Creating member...');
      const memberResponse = await fetch('/members/api/send-magic-link/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: email,
          emailType: 'signup'
        })
      });
      
      if (!memberResponse.ok) {
        const errorText = await memberResponse.text();
        console.error('API Error:', memberResponse.status, errorText);
        throw new Error('Failed to create member');
      }
      
      console.log('Member creation successful');
      
      // Show success message
      successAlert.style.display = 'block';
      form.reset();
      
      // Re-check the checkboxes (since reset unchecks them)
      form.querySelectorAll('input[name="newsletters"]').forEach(cb => cb.checked = true);
      
    } catch (error) {
      console.error('Subscription error:', error);
      errorAlert.style.display = 'block';
    } finally {
      // Re-enable submit button
      submitBtn.disabled = false;
      submitBtn.textContent = '{{t "Subscribe" }}';
    }
  });
  
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }
});
</script><form data-members-form='signup' class='c-subscribe-form is-membership {{ formClass }}'>
  <div class='c-form-group'>
    <label for='{{ emailLabel }}' class='u-hidden-visually'>{{t 'Your email address' }}</label>
    <input type='email' name='email' class='c-form-group__input' id='{{ emailLabel }}' placeholder='{{t 'Your email address' }}' required data-members-email>
    <button type='submit' value='{{t 'Subscribe' }}' class='c-btn c-form-group__btn'>{{t 'Subscribe' }}</button>
  </div>

  <div class='c-newsletter-info'>
    <p class='u-mb-8'>{{t 'Subscribe to Draft Mode and beating newsletters' }}</p>
  </div>

  <p class='u-mb-16 unsub'>{{t 'No spam. Unsubscribe any time.' }}</p>

  <div class='c-alert c-alert--success'>{{t 'Please check your inbox and click the link to confirm your subscription.' }}</div>
  <div class='c-alert c-alert--invalid'>{{t 'Please enter a valid email address!' }}</div>
  <div class='c-alert c-alert--error'>{{t 'An error occurred, please try again later.' }}</div>
</form>